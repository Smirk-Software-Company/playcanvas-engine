import { math } from '../../../core/math/math.js';
import { ORIENTATION_HORIZONTAL } from '../../../scene/constants.js';
import { Component } from '../component.js';
import { ElementDragHelper } from '../element/element-drag-helper.js';
import { EntityReference } from '../../utils/entity-reference.js';

/**
 * A ScrollbarComponent enables a group of entities to behave like a draggable scrollbar.
 *
 * @property {number} orientation Whether the scrollbar moves horizontally or vertically. Can be:
 *
 * - {@link ORIENTATION_HORIZONTAL}: The scrollbar animates in the horizontal axis.
 * - {@link ORIENTATION_VERTICAL}: The scrollbar animates in the vertical axis.
 *
 * Defaults to {@link ORIENTATION_HORIZONTAL}.
 * @property {number} value The current position value of the scrollbar, in the range 0 to 1.
 * Defaults to 0.
 * @property {number} handleSize The size of the handle relative to the size of the track, in the
 * range 0 to 1. For a vertical scrollbar, a value of 1 means that the handle will take up the full
 * height of the track.
 * @property {import('../../entity.js').Entity} handleEntity The entity to be used as the scrollbar
 * handle. This entity must have a Scrollbar component.
 * @augments Component
 * @category User Interface
 */
class ScrollbarComponent extends Component {
  /**
   * Create a new ScrollbarComponent.
   *
   * @param {import('./system.js').ScrollbarComponentSystem} system - The ComponentSystem that
   * created this Component.
   * @param {import('../../entity.js').Entity} entity - The Entity that this Component is
   * attached to.
   */
  constructor(system, entity) {
    super(system, entity);
    this._handleReference = new EntityReference(this, 'handleEntity', {
      'element#gain': this._onHandleElementGain,
      'element#lose': this._onHandleElementLose,
      'element#set:anchor': this._onSetHandleAlignment,
      'element#set:margin': this._onSetHandleAlignment,
      'element#set:pivot': this._onSetHandleAlignment
    });
    this._toggleLifecycleListeners('on');
  }

  /**
   * Fired whenever the scroll value changes.
   *
   * @event ScrollbarComponent#set:value
   * @param {number} value - The current scroll value.
   */

  /**
   * @param {string} onOrOff - 'on' or 'off'.
   * @private
   */
  _toggleLifecycleListeners(onOrOff) {
    this[onOrOff]('set_value', this._onSetValue, this);
    this[onOrOff]('set_handleSize', this._onSetHandleSize, this);
    this[onOrOff]('set_orientation', this._onSetOrientation, this);

    // TODO Handle scrollwheel events
  }

  _onHandleElementGain() {
    this._destroyDragHelper();
    this._handleDragHelper = new ElementDragHelper(this._handleReference.entity.element, this._getAxis());
    this._handleDragHelper.on('drag:move', this._onHandleDrag, this);
    this._updateHandlePositionAndSize();
  }
  _onHandleElementLose() {
    this._destroyDragHelper();
  }
  _onHandleDrag(position) {
    if (this._handleReference.entity && this.enabled && this.entity.enabled) {
      this.value = this._handlePositionToScrollValue(position[this._getAxis()]);
    }
  }
  _onSetValue(name, oldValue, newValue) {
    if (Math.abs(newValue - oldValue) > 1e-5) {
      this.data.value = math.clamp(newValue, 0, 1);
      this._updateHandlePositionAndSize();
      this.fire('set:value', this.data.value);
    }
  }
  _onSetHandleSize(name, oldValue, newValue) {
    if (Math.abs(newValue - oldValue) > 1e-5) {
      this.data.handleSize = math.clamp(newValue, 0, 1);
      this._updateHandlePositionAndSize();
    }
  }
  _onSetHandleAlignment() {
    this._updateHandlePositionAndSize();
  }
  _onSetOrientation(name, oldValue, newValue) {
    if (newValue !== oldValue && this._handleReference.hasComponent('element')) {
      this._handleReference.entity.element[this._getOppositeDimension()] = 0;
    }
  }
  _updateHandlePositionAndSize() {
    const handleEntity = this._handleReference.entity;
    const handleElement = handleEntity && handleEntity.element;
    if (handleEntity) {
      const position = handleEntity.getLocalPosition();
      position[this._getAxis()] = this._getHandlePosition();
      this._handleReference.entity.setLocalPosition(position);
    }
    if (handleElement) {
      handleElement[this._getDimension()] = this._getHandleLength();
    }
  }
  _handlePositionToScrollValue(handlePosition) {
    return handlePosition * this._getSign() / this._getUsableTrackLength();
  }
  _scrollValueToHandlePosition(value) {
    return value * this._getSign() * this._getUsableTrackLength();
  }
  _getUsableTrackLength() {
    return Math.max(this._getTrackLength() - this._getHandleLength(), 0.001);
  }
  _getTrackLength() {
    if (this.entity.element) {
      return this.orientation === ORIENTATION_HORIZONTAL ? this.entity.element.calculatedWidth : this.entity.element.calculatedHeight;
    }
    return 0;
  }
  _getHandleLength() {
    return this._getTrackLength() * this.handleSize;
  }
  _getHandlePosition() {
    return this._scrollValueToHandlePosition(this.value);
  }
  _getSign() {
    return this.orientation === ORIENTATION_HORIZONTAL ? 1 : -1;
  }
  _getAxis() {
    return this.orientation === ORIENTATION_HORIZONTAL ? 'x' : 'y';
  }
  _getDimension() {
    return this.orientation === ORIENTATION_HORIZONTAL ? 'width' : 'height';
  }
  _getOppositeDimension() {
    return this.orientation === ORIENTATION_HORIZONTAL ? 'height' : 'width';
  }
  _destroyDragHelper() {
    if (this._handleDragHelper) {
      this._handleDragHelper.destroy();
    }
  }
  _setHandleDraggingEnabled(enabled) {
    if (this._handleDragHelper) {
      this._handleDragHelper.enabled = enabled;
    }
  }
  onEnable() {
    this._handleReference.onParentComponentEnable();
    this._setHandleDraggingEnabled(true);
  }
  onDisable() {
    this._setHandleDraggingEnabled(false);
  }
  onRemove() {
    this._destroyDragHelper();
    this._toggleLifecycleListeners('off');
  }
}

export { ScrollbarComponent };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnJhbWV3b3JrL2NvbXBvbmVudHMvc2Nyb2xsYmFyL2NvbXBvbmVudC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtYXRoIH0gZnJvbSAnLi4vLi4vLi4vY29yZS9tYXRoL21hdGguanMnO1xuXG5pbXBvcnQgeyBPUklFTlRBVElPTl9IT1JJWk9OVEFMIH0gZnJvbSAnLi4vLi4vLi4vc2NlbmUvY29uc3RhbnRzLmpzJztcblxuaW1wb3J0IHsgQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50LmpzJztcblxuaW1wb3J0IHsgRWxlbWVudERyYWdIZWxwZXIgfSBmcm9tICcuLi9lbGVtZW50L2VsZW1lbnQtZHJhZy1oZWxwZXIuanMnO1xuXG5pbXBvcnQgeyBFbnRpdHlSZWZlcmVuY2UgfSBmcm9tICcuLi8uLi91dGlscy9lbnRpdHktcmVmZXJlbmNlLmpzJztcblxuLyoqXG4gKiBBIFNjcm9sbGJhckNvbXBvbmVudCBlbmFibGVzIGEgZ3JvdXAgb2YgZW50aXRpZXMgdG8gYmVoYXZlIGxpa2UgYSBkcmFnZ2FibGUgc2Nyb2xsYmFyLlxuICpcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBvcmllbnRhdGlvbiBXaGV0aGVyIHRoZSBzY3JvbGxiYXIgbW92ZXMgaG9yaXpvbnRhbGx5IG9yIHZlcnRpY2FsbHkuIENhbiBiZTpcbiAqXG4gKiAtIHtAbGluayBPUklFTlRBVElPTl9IT1JJWk9OVEFMfTogVGhlIHNjcm9sbGJhciBhbmltYXRlcyBpbiB0aGUgaG9yaXpvbnRhbCBheGlzLlxuICogLSB7QGxpbmsgT1JJRU5UQVRJT05fVkVSVElDQUx9OiBUaGUgc2Nyb2xsYmFyIGFuaW1hdGVzIGluIHRoZSB2ZXJ0aWNhbCBheGlzLlxuICpcbiAqIERlZmF1bHRzIHRvIHtAbGluayBPUklFTlRBVElPTl9IT1JJWk9OVEFMfS5cbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2YWx1ZSBUaGUgY3VycmVudCBwb3NpdGlvbiB2YWx1ZSBvZiB0aGUgc2Nyb2xsYmFyLCBpbiB0aGUgcmFuZ2UgMCB0byAxLlxuICogRGVmYXVsdHMgdG8gMC5cbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoYW5kbGVTaXplIFRoZSBzaXplIG9mIHRoZSBoYW5kbGUgcmVsYXRpdmUgdG8gdGhlIHNpemUgb2YgdGhlIHRyYWNrLCBpbiB0aGVcbiAqIHJhbmdlIDAgdG8gMS4gRm9yIGEgdmVydGljYWwgc2Nyb2xsYmFyLCBhIHZhbHVlIG9mIDEgbWVhbnMgdGhhdCB0aGUgaGFuZGxlIHdpbGwgdGFrZSB1cCB0aGUgZnVsbFxuICogaGVpZ2h0IG9mIHRoZSB0cmFjay5cbiAqIEBwcm9wZXJ0eSB7aW1wb3J0KCcuLi8uLi9lbnRpdHkuanMnKS5FbnRpdHl9IGhhbmRsZUVudGl0eSBUaGUgZW50aXR5IHRvIGJlIHVzZWQgYXMgdGhlIHNjcm9sbGJhclxuICogaGFuZGxlLiBUaGlzIGVudGl0eSBtdXN0IGhhdmUgYSBTY3JvbGxiYXIgY29tcG9uZW50LlxuICogQGF1Z21lbnRzIENvbXBvbmVudFxuICogQGNhdGVnb3J5IFVzZXIgSW50ZXJmYWNlXG4gKi9cbmNsYXNzIFNjcm9sbGJhckNvbXBvbmVudCBleHRlbmRzIENvbXBvbmVudCB7XG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IFNjcm9sbGJhckNvbXBvbmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW1wb3J0KCcuL3N5c3RlbS5qcycpLlNjcm9sbGJhckNvbXBvbmVudFN5c3RlbX0gc3lzdGVtIC0gVGhlIENvbXBvbmVudFN5c3RlbSB0aGF0XG4gICAgICogY3JlYXRlZCB0aGlzIENvbXBvbmVudC5cbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vLi4vZW50aXR5LmpzJykuRW50aXR5fSBlbnRpdHkgLSBUaGUgRW50aXR5IHRoYXQgdGhpcyBDb21wb25lbnQgaXNcbiAgICAgKiBhdHRhY2hlZCB0by5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihzeXN0ZW0sIGVudGl0eSkge1xuICAgICAgICBzdXBlcihzeXN0ZW0sIGVudGl0eSk7XG5cbiAgICAgICAgdGhpcy5faGFuZGxlUmVmZXJlbmNlID0gbmV3IEVudGl0eVJlZmVyZW5jZSh0aGlzLCAnaGFuZGxlRW50aXR5Jywge1xuICAgICAgICAgICAgJ2VsZW1lbnQjZ2Fpbic6IHRoaXMuX29uSGFuZGxlRWxlbWVudEdhaW4sXG4gICAgICAgICAgICAnZWxlbWVudCNsb3NlJzogdGhpcy5fb25IYW5kbGVFbGVtZW50TG9zZSxcbiAgICAgICAgICAgICdlbGVtZW50I3NldDphbmNob3InOiB0aGlzLl9vblNldEhhbmRsZUFsaWdubWVudCxcbiAgICAgICAgICAgICdlbGVtZW50I3NldDptYXJnaW4nOiB0aGlzLl9vblNldEhhbmRsZUFsaWdubWVudCxcbiAgICAgICAgICAgICdlbGVtZW50I3NldDpwaXZvdCc6IHRoaXMuX29uU2V0SGFuZGxlQWxpZ25tZW50XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX3RvZ2dsZUxpZmVjeWNsZUxpc3RlbmVycygnb24nKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaXJlZCB3aGVuZXZlciB0aGUgc2Nyb2xsIHZhbHVlIGNoYW5nZXMuXG4gICAgICpcbiAgICAgKiBAZXZlbnQgU2Nyb2xsYmFyQ29tcG9uZW50I3NldDp2YWx1ZVxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBjdXJyZW50IHNjcm9sbCB2YWx1ZS5cbiAgICAgKi9cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBvbk9yT2ZmIC0gJ29uJyBvciAnb2ZmJy5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF90b2dnbGVMaWZlY3ljbGVMaXN0ZW5lcnMob25Pck9mZikge1xuICAgICAgICB0aGlzW29uT3JPZmZdKCdzZXRfdmFsdWUnLCB0aGlzLl9vblNldFZhbHVlLCB0aGlzKTtcbiAgICAgICAgdGhpc1tvbk9yT2ZmXSgnc2V0X2hhbmRsZVNpemUnLCB0aGlzLl9vblNldEhhbmRsZVNpemUsIHRoaXMpO1xuICAgICAgICB0aGlzW29uT3JPZmZdKCdzZXRfb3JpZW50YXRpb24nLCB0aGlzLl9vblNldE9yaWVudGF0aW9uLCB0aGlzKTtcblxuICAgICAgICAvLyBUT0RPIEhhbmRsZSBzY3JvbGx3aGVlbCBldmVudHNcbiAgICB9XG5cbiAgICBfb25IYW5kbGVFbGVtZW50R2FpbigpIHtcbiAgICAgICAgdGhpcy5fZGVzdHJveURyYWdIZWxwZXIoKTtcbiAgICAgICAgdGhpcy5faGFuZGxlRHJhZ0hlbHBlciA9IG5ldyBFbGVtZW50RHJhZ0hlbHBlcih0aGlzLl9oYW5kbGVSZWZlcmVuY2UuZW50aXR5LmVsZW1lbnQsIHRoaXMuX2dldEF4aXMoKSk7XG4gICAgICAgIHRoaXMuX2hhbmRsZURyYWdIZWxwZXIub24oJ2RyYWc6bW92ZScsIHRoaXMuX29uSGFuZGxlRHJhZywgdGhpcyk7XG5cbiAgICAgICAgdGhpcy5fdXBkYXRlSGFuZGxlUG9zaXRpb25BbmRTaXplKCk7XG4gICAgfVxuXG4gICAgX29uSGFuZGxlRWxlbWVudExvc2UoKSB7XG4gICAgICAgIHRoaXMuX2Rlc3Ryb3lEcmFnSGVscGVyKCk7XG4gICAgfVxuXG4gICAgX29uSGFuZGxlRHJhZyhwb3NpdGlvbikge1xuICAgICAgICBpZiAodGhpcy5faGFuZGxlUmVmZXJlbmNlLmVudGl0eSAmJiB0aGlzLmVuYWJsZWQgJiYgdGhpcy5lbnRpdHkuZW5hYmxlZCkge1xuICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuX2hhbmRsZVBvc2l0aW9uVG9TY3JvbGxWYWx1ZShwb3NpdGlvblt0aGlzLl9nZXRBeGlzKCldKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9vblNldFZhbHVlKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgICAgICBpZiAoTWF0aC5hYnMobmV3VmFsdWUgLSBvbGRWYWx1ZSkgPiAxZS01KSB7XG4gICAgICAgICAgICB0aGlzLmRhdGEudmFsdWUgPSBtYXRoLmNsYW1wKG5ld1ZhbHVlLCAwLCAxKTtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhbmRsZVBvc2l0aW9uQW5kU2l6ZSgpO1xuICAgICAgICAgICAgdGhpcy5maXJlKCdzZXQ6dmFsdWUnLCB0aGlzLmRhdGEudmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX29uU2V0SGFuZGxlU2l6ZShuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICAgICAgaWYgKE1hdGguYWJzKG5ld1ZhbHVlIC0gb2xkVmFsdWUpID4gMWUtNSkge1xuICAgICAgICAgICAgdGhpcy5kYXRhLmhhbmRsZVNpemUgPSBtYXRoLmNsYW1wKG5ld1ZhbHVlLCAwLCAxKTtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhbmRsZVBvc2l0aW9uQW5kU2l6ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX29uU2V0SGFuZGxlQWxpZ25tZW50KCkge1xuICAgICAgICB0aGlzLl91cGRhdGVIYW5kbGVQb3NpdGlvbkFuZFNpemUoKTtcbiAgICB9XG5cbiAgICBfb25TZXRPcmllbnRhdGlvbihuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHtcbiAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBvbGRWYWx1ZSAmJiB0aGlzLl9oYW5kbGVSZWZlcmVuY2UuaGFzQ29tcG9uZW50KCdlbGVtZW50JykpIHtcbiAgICAgICAgICAgIHRoaXMuX2hhbmRsZVJlZmVyZW5jZS5lbnRpdHkuZWxlbWVudFt0aGlzLl9nZXRPcHBvc2l0ZURpbWVuc2lvbigpXSA9IDA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfdXBkYXRlSGFuZGxlUG9zaXRpb25BbmRTaXplKCkge1xuICAgICAgICBjb25zdCBoYW5kbGVFbnRpdHkgPSB0aGlzLl9oYW5kbGVSZWZlcmVuY2UuZW50aXR5O1xuICAgICAgICBjb25zdCBoYW5kbGVFbGVtZW50ID0gaGFuZGxlRW50aXR5ICYmIGhhbmRsZUVudGl0eS5lbGVtZW50O1xuXG4gICAgICAgIGlmIChoYW5kbGVFbnRpdHkpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gaGFuZGxlRW50aXR5LmdldExvY2FsUG9zaXRpb24oKTtcbiAgICAgICAgICAgIHBvc2l0aW9uW3RoaXMuX2dldEF4aXMoKV0gPSB0aGlzLl9nZXRIYW5kbGVQb3NpdGlvbigpO1xuICAgICAgICAgICAgdGhpcy5faGFuZGxlUmVmZXJlbmNlLmVudGl0eS5zZXRMb2NhbFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYW5kbGVFbGVtZW50KSB7XG4gICAgICAgICAgICBoYW5kbGVFbGVtZW50W3RoaXMuX2dldERpbWVuc2lvbigpXSA9IHRoaXMuX2dldEhhbmRsZUxlbmd0aCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2hhbmRsZVBvc2l0aW9uVG9TY3JvbGxWYWx1ZShoYW5kbGVQb3NpdGlvbikge1xuICAgICAgICByZXR1cm4gaGFuZGxlUG9zaXRpb24gKiB0aGlzLl9nZXRTaWduKCkgLyB0aGlzLl9nZXRVc2FibGVUcmFja0xlbmd0aCgpO1xuICAgIH1cblxuICAgIF9zY3JvbGxWYWx1ZVRvSGFuZGxlUG9zaXRpb24odmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlICogdGhpcy5fZ2V0U2lnbigpICogdGhpcy5fZ2V0VXNhYmxlVHJhY2tMZW5ndGgoKTtcbiAgICB9XG5cbiAgICBfZ2V0VXNhYmxlVHJhY2tMZW5ndGgoKSB7XG4gICAgICAgIHJldHVybiBNYXRoLm1heCh0aGlzLl9nZXRUcmFja0xlbmd0aCgpIC0gdGhpcy5fZ2V0SGFuZGxlTGVuZ3RoKCksIDAuMDAxKTtcbiAgICB9XG5cbiAgICBfZ2V0VHJhY2tMZW5ndGgoKSB7XG4gICAgICAgIGlmICh0aGlzLmVudGl0eS5lbGVtZW50KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PT0gT1JJRU5UQVRJT05fSE9SSVpPTlRBTCA/IHRoaXMuZW50aXR5LmVsZW1lbnQuY2FsY3VsYXRlZFdpZHRoIDogdGhpcy5lbnRpdHkuZWxlbWVudC5jYWxjdWxhdGVkSGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgX2dldEhhbmRsZUxlbmd0aCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFRyYWNrTGVuZ3RoKCkgKiB0aGlzLmhhbmRsZVNpemU7XG4gICAgfVxuXG4gICAgX2dldEhhbmRsZVBvc2l0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2Nyb2xsVmFsdWVUb0hhbmRsZVBvc2l0aW9uKHRoaXMudmFsdWUpO1xuICAgIH1cblxuICAgIF9nZXRTaWduKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PT0gT1JJRU5UQVRJT05fSE9SSVpPTlRBTCA/IDEgOiAtMTtcbiAgICB9XG5cbiAgICBfZ2V0QXhpcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3JpZW50YXRpb24gPT09IE9SSUVOVEFUSU9OX0hPUklaT05UQUwgPyAneCcgOiAneSc7XG4gICAgfVxuXG4gICAgX2dldERpbWVuc2lvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3JpZW50YXRpb24gPT09IE9SSUVOVEFUSU9OX0hPUklaT05UQUwgPyAnd2lkdGgnIDogJ2hlaWdodCc7XG4gICAgfVxuXG4gICAgX2dldE9wcG9zaXRlRGltZW5zaW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PT0gT1JJRU5UQVRJT05fSE9SSVpPTlRBTCA/ICdoZWlnaHQnIDogJ3dpZHRoJztcbiAgICB9XG5cbiAgICBfZGVzdHJveURyYWdIZWxwZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLl9oYW5kbGVEcmFnSGVscGVyKSB7XG4gICAgICAgICAgICB0aGlzLl9oYW5kbGVEcmFnSGVscGVyLmRlc3Ryb3koKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9zZXRIYW5kbGVEcmFnZ2luZ0VuYWJsZWQoZW5hYmxlZCkge1xuICAgICAgICBpZiAodGhpcy5faGFuZGxlRHJhZ0hlbHBlcikge1xuICAgICAgICAgICAgdGhpcy5faGFuZGxlRHJhZ0hlbHBlci5lbmFibGVkID0gZW5hYmxlZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uRW5hYmxlKCkge1xuICAgICAgICB0aGlzLl9oYW5kbGVSZWZlcmVuY2Uub25QYXJlbnRDb21wb25lbnRFbmFibGUoKTtcbiAgICAgICAgdGhpcy5fc2V0SGFuZGxlRHJhZ2dpbmdFbmFibGVkKHRydWUpO1xuICAgIH1cblxuICAgIG9uRGlzYWJsZSgpIHtcbiAgICAgICAgdGhpcy5fc2V0SGFuZGxlRHJhZ2dpbmdFbmFibGVkKGZhbHNlKTtcbiAgICB9XG5cbiAgICBvblJlbW92ZSgpIHtcbiAgICAgICAgdGhpcy5fZGVzdHJveURyYWdIZWxwZXIoKTtcbiAgICAgICAgdGhpcy5fdG9nZ2xlTGlmZWN5Y2xlTGlzdGVuZXJzKCdvZmYnKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFNjcm9sbGJhckNvbXBvbmVudCB9O1xuIl0sIm5hbWVzIjpbIlNjcm9sbGJhckNvbXBvbmVudCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwic3lzdGVtIiwiZW50aXR5IiwiX2hhbmRsZVJlZmVyZW5jZSIsIkVudGl0eVJlZmVyZW5jZSIsIl9vbkhhbmRsZUVsZW1lbnRHYWluIiwiX29uSGFuZGxlRWxlbWVudExvc2UiLCJfb25TZXRIYW5kbGVBbGlnbm1lbnQiLCJfdG9nZ2xlTGlmZWN5Y2xlTGlzdGVuZXJzIiwib25Pck9mZiIsIl9vblNldFZhbHVlIiwiX29uU2V0SGFuZGxlU2l6ZSIsIl9vblNldE9yaWVudGF0aW9uIiwiX2Rlc3Ryb3lEcmFnSGVscGVyIiwiX2hhbmRsZURyYWdIZWxwZXIiLCJFbGVtZW50RHJhZ0hlbHBlciIsImVsZW1lbnQiLCJfZ2V0QXhpcyIsIm9uIiwiX29uSGFuZGxlRHJhZyIsIl91cGRhdGVIYW5kbGVQb3NpdGlvbkFuZFNpemUiLCJwb3NpdGlvbiIsImVuYWJsZWQiLCJ2YWx1ZSIsIl9oYW5kbGVQb3NpdGlvblRvU2Nyb2xsVmFsdWUiLCJuYW1lIiwib2xkVmFsdWUiLCJuZXdWYWx1ZSIsIk1hdGgiLCJhYnMiLCJkYXRhIiwibWF0aCIsImNsYW1wIiwiZmlyZSIsImhhbmRsZVNpemUiLCJoYXNDb21wb25lbnQiLCJfZ2V0T3Bwb3NpdGVEaW1lbnNpb24iLCJoYW5kbGVFbnRpdHkiLCJoYW5kbGVFbGVtZW50IiwiZ2V0TG9jYWxQb3NpdGlvbiIsIl9nZXRIYW5kbGVQb3NpdGlvbiIsInNldExvY2FsUG9zaXRpb24iLCJfZ2V0RGltZW5zaW9uIiwiX2dldEhhbmRsZUxlbmd0aCIsImhhbmRsZVBvc2l0aW9uIiwiX2dldFNpZ24iLCJfZ2V0VXNhYmxlVHJhY2tMZW5ndGgiLCJfc2Nyb2xsVmFsdWVUb0hhbmRsZVBvc2l0aW9uIiwibWF4IiwiX2dldFRyYWNrTGVuZ3RoIiwib3JpZW50YXRpb24iLCJPUklFTlRBVElPTl9IT1JJWk9OVEFMIiwiY2FsY3VsYXRlZFdpZHRoIiwiY2FsY3VsYXRlZEhlaWdodCIsImRlc3Ryb3kiLCJfc2V0SGFuZGxlRHJhZ2dpbmdFbmFibGVkIiwib25FbmFibGUiLCJvblBhcmVudENvbXBvbmVudEVuYWJsZSIsIm9uRGlzYWJsZSIsIm9uUmVtb3ZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFVQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLGtCQUFrQixTQUFTQyxTQUFTLENBQUM7QUFDdkM7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxXQUFXQSxDQUFDQyxNQUFNLEVBQUVDLE1BQU0sRUFBRTtBQUN4QixJQUFBLEtBQUssQ0FBQ0QsTUFBTSxFQUFFQyxNQUFNLENBQUMsQ0FBQTtJQUVyQixJQUFJLENBQUNDLGdCQUFnQixHQUFHLElBQUlDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsY0FBYyxF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
