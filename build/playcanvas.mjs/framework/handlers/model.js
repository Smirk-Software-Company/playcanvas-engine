import { path } from '../../core/path.js';
import { Http, http } from '../../platform/net/http.js';
import { getDefaultMaterial } from '../../scene/materials/default-material.js';
import { GlbModelParser } from '../parsers/glb-model.js';
import { JsonModelParser } from '../parsers/json-model.js';

/** @typedef {import('./handler.js').ResourceHandler} ResourceHandler */

/**
 * Callback used by {@link ModelHandler#addParser} to decide on which parser to use.
 *
 * @callback AddParserCallback
 * @param {string} url - The resource url.
 * @param {object} data - The raw model data.
 * @returns {boolean} Return true if this parser should be used to parse the data into a
 * {@link Model}.
 */

/**
 * Resource handler used for loading {@link Model} resources.
 *
 * @implements {ResourceHandler}
 * @category Graphics
 */
class ModelHandler {
  /**
   * Create a new ModelHandler instance.
   *
   * @param {import('../app-base.js').AppBase} app - The running {@link AppBase}.
   * @hideconstructor
   */
  constructor(app) {
    /**
     * Type of the resource the handler handles.
     *
     * @type {string}
     */
    this.handlerType = "model";
    this._parsers = [];
    this.device = app.graphicsDevice;
    this.assets = app.assets;
    this.defaultMaterial = getDefaultMaterial(this.device);
    this.maxRetries = 0;
    this.addParser(new JsonModelParser(this), function (url, data) {
      return path.getExtension(url) === '.json';
    });
    this.addParser(new GlbModelParser(this), function (url, data) {
      return path.getExtension(url) === '.glb';
    });
  }
  load(url, callback, asset) {
    if (typeof url === 'string') {
      url = {
        load: url,
        original: url
      };
    }

    // we need to specify JSON for blob URLs
    const options = {
      retry: this.maxRetries > 0,
      maxRetries: this.maxRetries
    };
    if (url.load.startsWith('blob:') || url.load.startsWith('data:')) {
      if (path.getExtension(url.original).toLowerCase() === '.glb') {
        options.responseType = Http.ResponseType.ARRAY_BUFFER;
      } else {
        options.responseType = Http.ResponseType.JSON;
      }
    }
    http.get(url.load, options, (err, response) => {
      if (!callback) return;
      if (!err) {
        // parse the model
        for (let i = 0; i < this._parsers.length; i++) {
          const p = this._parsers[i];
          if (p.decider(url.original, response)) {
            p.parser.parse(response, (err, parseResult) => {
              if (err) {
                callback(err);
              } else {
                callback(null, parseResult);
              }
            }, asset);
            return;
          }
        }
        callback("No parsers found");
      } else {
        callback(`Error loading model: ${url.original} [${err}]`);
      }
    });
  }
  open(url, data) {
    // parse was done in open, return the data as-is
    return data;
  }
  patch(asset, assets) {
    if (!asset.resource) return;
    const data = asset.data;
    const self = this;
    asset.resource.meshInstances.forEach(function (meshInstance, i) {
      if (data.mapping) {
        const handleMaterial = function handleMaterial(asset) {
          if (asset.resource) {
            meshInstance.material = asset.resource;
          } else {
            asset.once('load', handleMaterial);
            assets.load(asset);
          }
          asset.once('remove', function (asset) {
            if (meshInstance.material === asset.resource) {
              meshInstance.material = self.defaultMaterial;
            }
          });
        };
        if (!data.mapping[i]) {
          meshInstance.material = self.defaultMaterial;
          return;
        }
        const id = data.mapping[i].material;
        const url = data.mapping[i].path;
        let material;
        if (id !== undefined) {
          // id mapping
          if (!id) {
            meshInstance.material = self.defaultMaterial;
          } else {
            material = assets.get(id);
            if (material) {
              handleMaterial(material);
            } else {
              assets.once('add:' + id, handleMaterial);
            }
          }
        } else if (url) {
          // url mapping
          const path = asset.getAbsoluteUrl(data.mapping[i].path);
          material = assets.getByUrl(path);
          if (material) {
            handleMaterial(material);
          } else {
            assets.once('add:url:' + path, handleMaterial);
          }
        }
      }
    });
  }

  /**
   * Add a parser that converts raw data into a {@link Model}. Default parser is for JSON models.
   *
   * @param {object} parser - See JsonModelParser for example.
   * @param {AddParserCallback} decider - Function that decides on which parser to use. Function
   * should take (url, data) arguments and return true if this parser should be used to parse the
   * data into a {@link Model}. The first parser to return true is used.
   */
  addParser(parser, decider) {
    this._parsers.push({
      parser: parser,
      decider: decider
    });
  }
}

export { ModelHandler };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9mcmFtZXdvcmsvaGFuZGxlcnMvbW9kZWwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcGF0aCB9IGZyb20gJy4uLy4uL2NvcmUvcGF0aC5qcyc7XG5cbmltcG9ydCB7IGh0dHAsIEh0dHAgfSBmcm9tICcuLi8uLi9wbGF0Zm9ybS9uZXQvaHR0cC5qcyc7XG5cbmltcG9ydCB7IGdldERlZmF1bHRNYXRlcmlhbCB9IGZyb20gJy4uLy4uL3NjZW5lL21hdGVyaWFscy9kZWZhdWx0LW1hdGVyaWFsLmpzJztcblxuaW1wb3J0IHsgR2xiTW9kZWxQYXJzZXIgfSBmcm9tICcuLi9wYXJzZXJzL2dsYi1tb2RlbC5qcyc7XG5pbXBvcnQgeyBKc29uTW9kZWxQYXJzZXIgfSBmcm9tICcuLi9wYXJzZXJzL2pzb24tbW9kZWwuanMnO1xuXG4vKiogQHR5cGVkZWYge2ltcG9ydCgnLi9oYW5kbGVyLmpzJykuUmVzb3VyY2VIYW5kbGVyfSBSZXNvdXJjZUhhbmRsZXIgKi9cblxuLyoqXG4gKiBDYWxsYmFjayB1c2VkIGJ5IHtAbGluayBNb2RlbEhhbmRsZXIjYWRkUGFyc2VyfSB0byBkZWNpZGUgb24gd2hpY2ggcGFyc2VyIHRvIHVzZS5cbiAqXG4gKiBAY2FsbGJhY2sgQWRkUGFyc2VyQ2FsbGJhY2tcbiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgcmVzb3VyY2UgdXJsLlxuICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBUaGUgcmF3IG1vZGVsIGRhdGEuXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJuIHRydWUgaWYgdGhpcyBwYXJzZXIgc2hvdWxkIGJlIHVzZWQgdG8gcGFyc2UgdGhlIGRhdGEgaW50byBhXG4gKiB7QGxpbmsgTW9kZWx9LlxuICovXG5cbi8qKlxuICogUmVzb3VyY2UgaGFuZGxlciB1c2VkIGZvciBsb2FkaW5nIHtAbGluayBNb2RlbH0gcmVzb3VyY2VzLlxuICpcbiAqIEBpbXBsZW1lbnRzIHtSZXNvdXJjZUhhbmRsZXJ9XG4gKiBAY2F0ZWdvcnkgR3JhcGhpY3NcbiAqL1xuY2xhc3MgTW9kZWxIYW5kbGVyIHtcbiAgICAvKipcbiAgICAgKiBUeXBlIG9mIHRoZSByZXNvdXJjZSB0aGUgaGFuZGxlciBoYW5kbGVzLlxuICAgICAqXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBoYW5kbGVyVHlwZSA9IFwibW9kZWxcIjtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBNb2RlbEhhbmRsZXIgaW5zdGFuY2UuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vYXBwLWJhc2UuanMnKS5BcHBCYXNlfSBhcHAgLSBUaGUgcnVubmluZyB7QGxpbmsgQXBwQmFzZX0uXG4gICAgICogQGhpZGVjb25zdHJ1Y3RvclxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGFwcCkge1xuICAgICAgICB0aGlzLl9wYXJzZXJzID0gW107XG4gICAgICAgIHRoaXMuZGV2aWNlID0gYXBwLmdyYXBoaWNzRGV2aWNlO1xuICAgICAgICB0aGlzLmFzc2V0cyA9IGFwcC5hc3NldHM7XG4gICAgICAgIHRoaXMuZGVmYXVsdE1hdGVyaWFsID0gZ2V0RGVmYXVsdE1hdGVyaWFsKHRoaXMuZGV2aWNlKTtcbiAgICAgICAgdGhpcy5tYXhSZXRyaWVzID0gMDtcblxuICAgICAgICB0aGlzLmFkZFBhcnNlcihuZXcgSnNvbk1vZGVsUGFyc2VyKHRoaXMpLCBmdW5jdGlvbiAodXJsLCBkYXRhKSB7XG4gICAgICAgICAgICByZXR1cm4gKHBhdGguZ2V0RXh0ZW5zaW9uKHVybCkgPT09ICcuanNvbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hZGRQYXJzZXIobmV3IEdsYk1vZGVsUGFyc2VyKHRoaXMpLCBmdW5jdGlvbiAodXJsLCBkYXRhKSB7XG4gICAgICAgICAgICByZXR1cm4gKHBhdGguZ2V0RXh0ZW5zaW9uKHVybCkgPT09ICcuZ2xiJyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGxvYWQodXJsLCBjYWxsYmFjaywgYXNzZXQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB1cmwgPSB7XG4gICAgICAgICAgICAgICAgbG9hZDogdXJsLFxuICAgICAgICAgICAgICAgIG9yaWdpbmFsOiB1cmxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICAvLyB3ZSBuZWVkIHRvIHNwZWNpZnkgSlNPTiBmb3IgYmxvYiBVUkxzXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICByZXRyeTogdGhpcy5tYXhSZXRyaWVzID4gMCxcbiAgICAgICAgICAgIG1heFJldHJpZXM6IHRoaXMubWF4UmV0cmllc1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh1cmwubG9hZC5zdGFydHNXaXRoKCdibG9iOicpIHx8IHVybC5sb2FkLnN0YXJ0c1dpdGgoJ2RhdGE6JykpIHtcbiAgICAgICAgICAgIGlmIChwYXRoLmdldEV4dGVuc2lvbih1cmwub3JpZ2luYWwpLnRvTG93ZXJDYXNlKCkgPT09ICcuZ2xiJykge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMucmVzcG9uc2VUeXBlID0gSHR0cC5SZXNwb25zZVR5cGUuQVJSQVlfQlVGRkVSO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLnJlc3BvbnNlVHlwZSA9IEh0dHAuUmVzcG9uc2VUeXBlLkpTT047XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBodHRwLmdldCh1cmwubG9hZCwgb3B0aW9ucywgKGVyciwgcmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIGlmICghY2FsbGJhY2spXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICAgIC8vIHBhcnNlIHRoZSBtb2RlbFxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcGFyc2Vycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5fcGFyc2Vyc1tpXTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAocC5kZWNpZGVyKHVybC5vcmlnaW5hbCwgcmVzcG9uc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnBhcnNlci5wYXJzZShyZXNwb25zZSwgKGVyciwgcGFyc2VSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgcGFyc2VSZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYWxsYmFjayhcIk5vIHBhcnNlcnMgZm91bmRcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGBFcnJvciBsb2FkaW5nIG1vZGVsOiAke3VybC5vcmlnaW5hbH0gWyR7ZXJyfV1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgb3Blbih1cmwsIGRhdGEpIHtcbiAgICAgICAgLy8gcGFyc2Ugd2FzIGRvbmUgaW4gb3BlbiwgcmV0dXJuIHRoZSBkYXRhIGFzLWlzXG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cblxuICAgIHBhdGNoKGFzc2V0LCBhc3NldHMpIHtcbiAgICAgICAgaWYgKCFhc3NldC5yZXNvdXJjZSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCBkYXRhID0gYXNzZXQuZGF0YTtcblxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgYXNzZXQucmVzb3VyY2UubWVzaEluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChtZXNoSW5zdGFuY2UsIGkpIHtcbiAgICAgICAgICAgIGlmIChkYXRhLm1hcHBpbmcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVNYXRlcmlhbCA9IGZ1bmN0aW9uIChhc3NldCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXNzZXQucmVzb3VyY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9IGFzc2V0LnJlc291cmNlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXQub25jZSgnbG9hZCcsIGhhbmRsZU1hdGVyaWFsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0cy5sb2FkKGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGFzc2V0Lm9uY2UoJ3JlbW92ZScsIGZ1bmN0aW9uIChhc3NldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9PT0gYXNzZXQucmVzb3VyY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSBzZWxmLmRlZmF1bHRNYXRlcmlhbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmICghZGF0YS5tYXBwaW5nW2ldKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lc2hJbnN0YW5jZS5tYXRlcmlhbCA9IHNlbGYuZGVmYXVsdE1hdGVyaWFsO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSBkYXRhLm1hcHBpbmdbaV0ubWF0ZXJpYWw7XG4gICAgICAgICAgICAgICAgY29uc3QgdXJsID0gZGF0YS5tYXBwaW5nW2ldLnBhdGg7XG4gICAgICAgICAgICAgICAgbGV0IG1hdGVyaWFsO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlkICE9PSB1bmRlZmluZWQpIHsgLy8gaWQgbWFwcGluZ1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNoSW5zdGFuY2UubWF0ZXJpYWwgPSBzZWxmLmRlZmF1bHRNYXRlcmlhbDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGVyaWFsID0gYXNzZXRzLmdldChpZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVNYXRlcmlhbChtYXRlcmlhbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0cy5vbmNlKCdhZGQ6JyArIGlkLCBoYW5kbGVNYXRlcmlhbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVybCkge1xuICAgICAgICAgICAgICAgICAgICAvLyB1cmwgbWFwcGluZ1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gYXNzZXQuZ2V0QWJzb2x1dGVVcmwoZGF0YS5tYXBwaW5nW2ldLnBhdGgpO1xuICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbCA9IGFzc2V0cy5nZXRCeVVybChwYXRoKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAobWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1hdGVyaWFsKG1hdGVyaWFsKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0cy5vbmNlKCdhZGQ6dXJsOicgKyBwYXRoLCBoYW5kbGVNYXRlcmlhbCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHBhcnNlciB0aGF0IGNvbnZlcnRzIHJhdyBkYXRhIGludG8gYSB7QGxpbmsgTW9kZWx9LiBEZWZhdWx0IHBhcnNlciBpcyBmb3IgSlNPTiBtb2RlbHMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFyc2VyIC0gU2VlIEpzb25Nb2RlbFBhcnNlciBmb3IgZXhhbXBsZS5cbiAgICAgKiBAcGFyYW0ge0FkZFBhcnNlckNhbGxiYWNrfSBkZWNpZGVyIC0gRnVuY3Rpb24gdGhhdCBkZWNpZGVzIG9uIHdoaWNoIHBhcnNlciB0byB1c2UuIEZ1bmN0aW9uXG4gICAgICogc2hvdWxkIHRha2UgKHVybCwgZGF0YSkgYXJndW1lbnRzIGFuZCByZXR1cm4gdHJ1ZSBpZiB0aGlzIHBhcnNlciBzaG91bGQgYmUgdXNlZCB0byBwYXJzZSB0aGVcbiAgICAgKiBkYXRhIGludG8gYSB7QGxpbmsgTW9kZWx9LiBUaGUgZmlyc3QgcGFyc2VyIHRvIHJldHVybiB0cnVlIGlzIHVzZWQuXG4gICAgICovXG4gICAgYWRkUGFyc2VyKHBhcnNlciwgZGVjaWRlcikge1xuICAgICAgICB0aGlzLl9wYXJzZXJzLnB1c2goe1xuICAgICAgICAgICAgcGFyc2VyOiBwYXJzZXIsXG4gICAgICAgICAgICBkZWNpZGVyOiBkZWNpZGVyXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgTW9kZWxIYW5kbGVyIH07XG4iXSwibmFtZXMiOlsiTW9kZWxIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJhcHAiLCJoYW5kbGVyVHlwZSIsIl9wYXJzZXJzIiwiZGV2aWNlIiwiZ3JhcGhpY3NEZXZpY2UiLCJhc3NldHMiLCJkZWZhdWx0TWF0ZXJpYWwiLCJnZXREZWZhdWx0TWF0ZXJpYWwiLCJtYXhSZXRyaWVzIiwiYWRkUGFyc2VyIiwiSnNvbk1vZGVsUGFyc2VyIiwidXJsIiwiZGF0YSIsInBhdGgiLCJnZXRFeHRlbnNpb24iLCJHbGJNb2RlbFBhcnNlciIsImxvYWQiLCJjYWxsYmFjayIsImFzc2V0Iiwib3JpZ2luYWwiLCJvcHRpb25zIiwicmV0cnkiLCJzdGFydHNXaXRoIiwidG9Mb3dlckNhc2UiLCJyZXNwb25zZVR5cGUiLCJIdHRwIiwiUmVzcG9uc2VUeXBlIiwiQVJSQVlfQlVGRkVSIiwiSlNPTiIsImh0dHAiLCJnZXQiLCJlcnIiLCJyZXNwb25zZSIsImkiLCJsZW5ndGgiLCJwIiwiZGVjaWRlciIsInBhcnNlciIsInBhcnNlIiwicGFyc2VSZXN1bHQiLCJvcGVuIiwicGF0Y2giLCJyZXNvdXJjZSIsInNlbGYiLCJtZXNoSW5zdGFuY2VzIiwiZm9yRWFjaCIsIm1lc2hJbnN0YW5jZSIsIm1hcHBpbmciLCJoYW5kbGVNYXRlcmlhbCIsIm1hdGVyaWFsIiwib25jZSIsImlkIiwidW5kZWZpbmVkIiwiZ2V0QWJzb2x1dGVVcmwiLCJnZXRCeVVybCIsInB1c2giXSwibWFwcGluZ3MiOiI7Ozs7OztBQVNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxZQUFZLENBQUM7QUFRZjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDSUMsV0FBV0EsQ0FBQ0MsR0FBRyxFQUFFO0FBYmpCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7SUFKSSxJQUtBQyxD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
